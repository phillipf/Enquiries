---
title: "EnquiriesAnalysisHTML"
author: "Phil Farrell"
date: "15 December 2016"
output:
  html_document: 
    fig_caption: yes
    fig_height: 8
    fig_width: 10
  pdf_document: default
---

```{r}
eval_cell = TRUE
```

```{r child='Setup.Rmd', eval=eval_cell}
```

```{sql connection=conn}

SELECT * FROM "CallQual3"

```

####High level summary

```{r overall summary, message=FALSE, warning=FALSE, include=FALSE}

CallQual3$SRM <- ifelse(!is.na(CallQual3$SR_SERV_CODE), "SRM", "RESOLVED")   

x <- length(unique(CallQual3$MEMO_CONSUMER))

Filter <- ddply(CallQual3, .(ENQUIRY), summarise, Total = length(MEMO_CONSUMER)/x) %>%
                      arrange(-Total) %>%
                      mutate(cumulative = cumsum(Total)/sum(Total)) %>%
                      filter(cumulative < 0.93)

EnquiryCountAnnual <- CallQual3

EnquiryCountAnnual[!(EnquiryCountAnnual$ENQUIRY %in% Filter$ENQUIRY),]$ENQUIRY <- "OTHER"

EnquiryCountAnnual <- ddply(EnquiryCountAnnual, .(ENQUIRY, USES, SRM), summarise, Total = length(MEMO_CONSUMER)) %>%
                      arrange(-Total) %>%
                      select(USES,
                             SRM,
                             ENQUIRY,
                             Total)

```

There were `r sum(EnquiryCountAnnual$Total)` customer Enquiries logged in Gentrack between Jun 2014 and July 2016. This is broken down by year and into customer type in table 1 below.

```{r xtable1, echo=FALSE, results="asis"}

FY15 <- interval(ymd(20140701), ymd(20150630))
FY16 <- interval(ymd(20150701), ymd(20160630))
                                                             
CallQual3$FY <- ifelse(CallQual3$MEMO_DATETIME %within% FY15, 2015, 2016)

FYSummary <- ddply(CallQual3, .(FY, USES), summarise, Total = length(MEMO_CONSUMER)) %>%
             spread(USES, Total) %>%
             mutate(TotalEnquiries = NONRES + RES)

print(xtable(FYSummary), type = "html")


```

```{r Financial year + SRM summary, message=FALSE, warning=FALSE, include=FALSE}

FYSRMSummary <- ddply(CallQual3, .(FY, USES, SRM), summarise, Total = length(MEMO_CONSUMER)) %>%
             # spread(SRM, Total) %>%
             # mutate(TotalEnquiries = NONRES + RES)
                arrange(FY, USES, -Total)


```

\n 
`r sum(FYSRMSummary[FYSRMSummary$SRM == "SRM",]$Total)` enquiries, or `r paste(round(100 * sum(FYSRMSummary[FYSRMSummary$SRM == "SRM",]$Total)/ sum(FYSRMSummary$Total), 1), "%", sep="")` of all enquiries, resulted in an SRM being created between Jun 2014 and July 2016. 
\n 
As a group `r round(100 * sum(FYSRMSummary[FYSRMSummary$SRM == "SRM" & FYSRMSummary$USES == "NONRES", 4])/ sum(FYSRMSummary[FYSRMSummary$USES == "NONRES", 4]), 1)`% of all non-residential customers' enquiries resulted in an SRM between Jun 2014 and July 2016. This is compared to a rate of `r round(100 * sum(FYSRMSummary[FYSRMSummary$SRM == "SRM" & FYSRMSummary$USES == "RES", 4])/ sum(FYSRMSummary[FYSRMSummary$USES == "RES", 4]), 1)`% of residential enquiries generating an SRM over the same time period.   

```{r Plot1, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

p1Annual <- ggplot(data = FYSRMSummary %>% arrange(-Total) %>% filter(SRM == "SRM"),
             aes(x = factor(USES),
                 fill= factor(SRM),
                 y = Total)) 

p1Annual <- p1Annual + geom_bar(stat="identity")

p1Annual <- p1Annual + facet_grid(facets=~FY)

p1Annual <- p1Annual + scale_y_continuous(labels = comma)

p1Annual


```

```{r Annual SRM summary, include=FALSE}

SRM_enquiry <- ddply(CallQual3 %>% filter(SRM == "SRM"), .(USES, ENQUIRY), summarise, Total = length(MEMO_CONSUMER)) %>%
                      arrange(-Total) #%>%
                      #mutate(cumulative = cumsum(Total)/sum(Total))# %>%
                      # filter(cumulative < 0.93)

SRM_enquiry_RES <- SRM_enquiry%>%
                   filter(USES == "RES") %>%
                   arrange(-Total) %>%
                   mutate(CumulativePercent = cumsum(Total)/sum(Total)) %>%
                   filter(CumulativePercent < 0.99) %>%
                   select(ENQUIRY, Total, CumulativePercent)

SRM_enquiry[SRM_enquiry$USES == "RES" & !(SRM_enquiry$ENQUIRY %in% SRM_enquiry_RES$ENQUIRY), ]$ENQUIRY <- "OTHER"

TopThree_RES <- SRM_enquiry_RES %>% 
                head(3) %>% 
                mutate(ENQUIRY = stri_trans_totitle(ENQUIRY)) %>% 
                .[["ENQUIRY"]]

SRM_enquiry_NRES <- SRM_enquiry%>%
                   filter(USES == "NONRES") %>%
                   arrange(-Total) %>%
                   mutate(CumulativePercent = cumsum(Total)/sum(Total)) %>%
                   filter(CumulativePercent < 0.99) %>%
                   select(ENQUIRY, Total, CumulativePercent)

SRM_enquiry[SRM_enquiry$USES == "NONRES" & !(SRM_enquiry$ENQUIRY %in% SRM_enquiry_NRES$ENQUIRY), ]$ENQUIRY <- "OTHER"

TopThree_NRES <- SRM_enquiry_NRES %>% 
                head(3) %>% 
                mutate(ENQUIRY = stri_trans_totitle(ENQUIRY)) %>% 
                .[["ENQUIRY"]]

SRM_enquiry <- aggregate(Total ~ USES + ENQUIRY, SRM_enquiry, sum)

SRM_enquiry <- SRM_enquiry %>%
               arrange(Total)



```
\n 
The graph and tables below show that the top three enquiry types ending up as SRMs were `r TopThree_NRES[1:2]` and `r TopThree_NRES[3]` for non-residential as well as `r TopThree_RES[1:2]` and `r TopThree_RES[3]` for residential customers.   

```{r Annual SRM plots, echo=FALSE, message=FALSE, warning=FALSE}

# CallQual3$SRM <- ifelse(!is.na(CallQual3$SR_SERV_CODE), "SRM", "RESOLVED")   

# x <- length(unique(CallQual3$MEMO_CONSUMER))

SRM_enquiry$ENQUIRY <- factor(SRM_enquiry$ENQUIRY, levels = SRM_enquiry$ENQUIRY)

p1Annual <- ggplot(data = SRM_enquiry,
             aes(x = USES,
                 y = Total,
                 fill= ENQUIRY
                 )) 

p1Annual <- p1Annual + geom_bar(stat="identity")

#p1Annual <- p1Annual + facet_grid(facets=~FY)

p1Annual 

# p1Annual <- ggplot(data = EnquiryCountAnnual,
#              aes(x = factor(USES),
#                  fill= factor(ENQUIRY),
#                  y = Total)) 
# 
# p1Annual <- p1Annual + geom_bar(stat="identity")
# 
# p1Annual

# EnquiryCountAnnual <- CallQual3
# 
# EnquiryCountAnnual[!(EnquiryCountAnnual$ENQUIRY %in% Filter$ENQUIRY),]$ENQUIRY <- "OTHER"
# 
# EnquiryCountAnnual <- ddply(EnquiryCountAnnual, .(ENQUIRY, USES, SRM), summarise, Total = length(MEMO_CONSUMER)) %>%
#                       arrange(-Total) %>%
#                       select(USES,
#                              SRM,
#                              ENQUIRY,
#                              Total)

#Filter for SRM == TRUE

# Filter <- ddply(CallQual3 %>% filter(SRM == "SRM"), .(ENQUIRY), summarise, Total = length(MEMO_CONSUMER)/x) %>%
#                       arrange(-Total) %>%
#                       mutate(cumulative = cumsum(Total)/sum(Total)) %>%
#                       filter(cumulative < 0.93)
# 
# SRMCountAnnual <- CallQual3
# 
# SRMCountAnnual[!(SRMCountAnnual$ENQUIRY %in% Filter$ENQUIRY),]$ENQUIRY <- "OTHER"
# 
# SRMCountAnnual <- ddply(SRMCountAnnual %>% filter(SRM == "SRM"), .(USES, ENQUIRY), summarise, Total = length(MEMO_CONSUMER))  %>%
#                       #mutate(Total = 100 * Total/sum(Total)) %>% 
#                       arrange(USES, -Total)
# 
# p2Annual <- ggplot(data = SRMCountAnnual,
#              aes(x = factor(USES),
#                  fill= factor(ENQUIRY),
#                  y = Total)) 
# 
# p2Annual <- p2Annual + geom_bar(stat="identity")

#p2Annual <- p2Annual + scale_y_continuous(labels = percent)

#p2Annual <- p2Annual + facet_grid(facets=~USES)

# p2Annual

#
#p2Annual
#selectInput("p2", "", c("", ""))
```

```{r xtable2, echo=FALSE, results="asis"}
      
print(xtable(SRM_enquiry_NRES, align = "cccr",latex.environments="center", format.args = list(digits = 2, format = c("d","d","s","f"))), type = "html", include.rownames=FALSE)

#print(xtable(m), add.to.row=list(list(1),"\\rowcolor[gray]{.8} "))
#print(xtable(SRM_enquiry_RES), type = "html")
```

##Non-residential SRM analsysis

####Internal SRMs

The graph below shows over `r 2 + 2` percent of all customer enquiries between Jun 2014 and July 2016 were resolved at first point of contact. Approximately X percent of all customer enquiries were from residential type customers. 

```{r Sankey graph, echo=FALSE, message=FALSE, warning=FALSE}

sankeyPlot <- function(df, name){
  sankeyPlot <- NULL
  sankeyPlot <- rCharts$new()    #We need to tell R where the Sankey library is.  #I put it as a subdirectory to my current working directory (.)
  sankeyPlot$setLib('http://timelyportfolio.github.io/rCharts_d3_sankey')    #We also need to point to an HTML template page
  sankeyPlot$setTemplate(script =  "http://timelyportfolio.github.io/rCharts_d3_sankey/layouts/chart.html")
  sankeyPlot$set(
    data = df,
    nodeWidth = 15,
    nodePadding = 10,
    layout = 32,
    width = 750,
    height = 500,
    labelFormat = ".1%"
  )
  sankeyPlot$save(paste(name, '.html', sep = ""))}

x <- length(unique(CallQual3$MEMO_CONSUMER))

EnquiryCountAnnual_sankey <- EnquiryCountAnnual

EndUse_enquiry <- aggregate(Total ~ USES + ENQUIRY, EnquiryCountAnnual, sum) %>%
                  mutate(Total = Total/sum(Total))

colnames(EndUse_enquiry) <- c("source", "target", "value")

Enquiry_SRM <- aggregate(Total ~ ENQUIRY + SRM, EnquiryCountAnnual, sum) %>%
                  mutate(Total = Total/sum(Total))

colnames(Enquiry_SRM) <- c("source", "target", "value")

Enduse_SRM = rbind(EndUse_enquiry, Enquiry_SRM)

#d <- data.frame(
  #id = grant_id, 
  #source = funding_agency, 
  #target = study_section, 
  #value = total_cost
#)
#devtools::install_github("rCharts", "ramnathv", ref = "dev")

sankeyPlot(Enduse_SRM, name = "Enduse_SRM")

htmltools::includeHTML("C:/Enquiries/data/Enduse_SRM.html")


```

Over 40,000 enquiries between Jun 2014 and July 2016 



```{r Non-res SRM flow, echo=FALSE, message=FALSE, warning=FALSE}

NONRES_SRM <- CallQual3 %>% filter(SRM == "SRM", USES == "NONRES")

Users <- read.csv("file:///N:/ABR/Output_2_RootCauseSRMandRepeats/SRSSreports/GentrackUsers.csv",
                  stringsAsFactors = FALSE) %>%
         select(USER_ID, FULL_NAME, ï..DEPARTMENT, Access)

NONRES_SRM <- NONRES_SRM %>%
               left_join(Users, by = c("MEMO_CREATOR" = "USER_ID")) %>%
               left_join(Users, by = c("SR_CLOSER" = "USER_ID"))

Filter <- ddply(NONRES_SRM, .(ENQUIRY), summarise, Total = length(MEMO_CONSUMER)) %>%
                      arrange(-Total) %>%
                      mutate(cumulative = cumsum(Total)/sum(Total)) %>%
                      filter(cumulative < 0.93)

Filter2 <- ddply(NONRES_SRM, .(SOTDESCRIPTION), summarise, Total = length(MEMO_CONSUMER)) %>%
                      arrange(-Total) %>%
                      mutate(cumulative = cumsum(Total)/sum(Total)) %>%
                      filter(cumulative < 0.9)

SRMCountAnnual <- NONRES_SRM

SRMCountAnnual[!(SRMCountAnnual$ENQUIRY %in% Filter$ENQUIRY),]$ENQUIRY <- "OTHER_ENQUIRY"

SRMCountAnnual[!(SRMCountAnnual$SOTDESCRIPTION %in% Filter2$SOTDESCRIPTION),]$SOTDESCRIPTION <- "OTHER_SRM"

SRM2 <- ddply(SRMCountAnnual, .(USES, ACC_TYPE, `ï..DEPARTMENT.x`, `ï..DEPARTMENT.y`, SR_CALL_METHOD, ENQUIRY, SOTDESCRIPTION, SR_CLOSER), summarise, Total = length(MEMO_CONSUMER)) %>% filter(complete.cases(.))

# x <- length(unique(filter(SRMCountAnnual, SRM == "SRM")$MEMO_CONSUMER))

USES_TYPE <- aggregate(Total ~ USES + ACC_TYPE, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(USES_TYPE) <- c("source", "target", "value")

USES_METHOD <- aggregate(Total ~ ACC_TYPE + SR_CALL_METHOD, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(USES_METHOD) <- c("source", "target", "value")

Enquiry_SRM <- aggregate(Total ~ SR_CALL_METHOD + ENQUIRY, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(Enquiry_SRM) <- c("source", "target", "value")

sankeyPlot(Enquiry_SRM, "Enquiry_SRM")

Enquiry_SOT <- aggregate(Total ~ ENQUIRY + SOTDESCRIPTION, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(Enquiry_SOT) <- c("source", "target", "value")

sankeyPlot(Enquiry_SOT, "Enquiry_SOT")

SOT_CLOSER <- aggregate(Total ~ SOTDESCRIPTION + SR_CLOSER, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(SOT_CLOSER) <- c("source", "target", "value")

SOT = rbind(Enquiry_SRM, USES_TYPE, USES_METHOD, Enquiry_SOT) 

sankeyPlot(SOT, "Enquiry_SOT")

htmltools::includeHTML("C:/Enquiries/data/Enquiry_SOT.html")

```

```{r Gentrack users Sankey, eval=FALSE, include=FALSE, echo=FALSE}

Enquiry_Creator <- aggregate(Total ~ SR_CALL_METHOD + `ï..DEPARTMENT.x`, SRM2, sum) %>%
                          mutate(Total = Total/sum(Total))

colnames(Enquiry_Creator) <- c("source", "target", "value")

Creator_Closer <- aggregate(Total ~ `ï..DEPARTMENT.x` + `ï..DEPARTMENT.y`, SRM2, sum) %>%
                           mutate(Total = Total/sum(Total),
                                  `ï..DEPARTMENT.y` = paste(`ï..DEPARTMENT.y`, "_end"))
 
colnames(Creator_Closer) <- c("source", "target", "value")

# Creator_Enquiry <- aggregate(Total ~ `ï..DEPARTMENT.x` + ENQUIRY, SRM2, sum) %>%
#                           mutate(Total = Total/sum(Total))
# 
# colnames(Creator_Enquiry) <- c("source", "target", "value")

# Enquiry_Closer <-  aggregate(Total ~ ENQUIRY + `ï..DEPARTMENT.y`, SRM2, sum) %>%
#                           mutate(Total = Total/sum(Total),
#                                  `ï..DEPARTMENT.y` = paste(`ï..DEPARTMENT.y`, "_end"))
# 
# colnames(Enquiry_Closer) <- c("source", "target", "value")

#Users = rbind(USES_TYPE, USES_METHOD, Enquiry_Creator, Creator_Enquiry,  Enquiry_Closer)

Users = rbind(USES_TYPE, USES_METHOD, Enquiry_Creator, Creator_Closer)

sankeyPlot(Users, "Enquiry_users")

htmltools::includeHTML("C:/Enquiries/data/Enquiry_users.html")

```

```{r Gentrack users Sankey - Internal removed, eval=FALSE, include=FALSE, echo=FALSE}

Users2 = rbind(USES_TYPE, USES_METHOD, Enquiry_Creator, Creator_Closer) %>%
         filter(source != "I", target != "I")

sankeyPlot(Users2, "Enquiry_users2")

htmltools::includeHTML("C:/Enquiries/data/Enquiry_users2.html")

```
